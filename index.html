<script>
const isMobile = /iPhone|Android.+Mobile/.test(navigator.userAgent)
const mapFile = isMobile ? "./map-mobile.svg" : "./map-full.svg"

let isPinching = false
let lastDistance = 0
let isZoomIn = false

function getDistance(touches){
    const dx = touches[0].clientX - touches[1].clientX
    const dy = touches[0].clientY - touches[1].clientY
    return Math.sqrt(dx*dx + dy*dy)
}

fetch(mapFile)
.then(res => res.text())
.then(svgData => {

    document.getElementById("map-wrapper").innerHTML = svgData

    const svg = document.querySelector("svg")

    if (!svg.getAttribute("viewBox")) {
        const bbox = svg.getBBox()
        svg.setAttribute("viewBox", `0 0 ${bbox.width} ${bbox.height}`)
    }

    // ===== 左右反転 =====
    const width = svg.viewBox.baseVal.width
    const g = document.createElementNS("http://www.w3.org/2000/svg","g")
    g.setAttribute("transform", `translate(${width},0) scale(-1,1)`)

    while(svg.firstChild){
        g.appendChild(svg.firstChild)
    }
    svg.appendChild(g)

    const prefs = g.querySelectorAll('.prefecture')

    // ===== ピンチ検出 =====
    document.addEventListener("touchstart", e=>{
        if(e.touches.length === 2){
            isPinching = true
            lastDistance = getDistance(e.touches)
        }
    }, {passive:true})

    document.addEventListener("touchmove", e=>{
        if(e.touches.length === 2){
            const distance = getDistance(e.touches)
            isZoomIn = distance < lastDistance
            lastDistance = distance
        }
    }, {passive:true})

    document.addEventListener("touchend", e=>{
        if(e.touches.length < 2){
            setTimeout(()=>{ isPinching = false },100)
            lastDistance = 0
        }
    }, {passive:true})

    const isTouchDevice = ('ontouchstart' in window)

    prefs.forEach(pref=>{

        const title = pref.querySelector("title")
        let label = null

        if(title){
            const name = title.textContent.split("/")[0].trim()

            const bbox = pref.getBBox()

            // ★ 重要：svg直下に追加（gの外）
            label = document.createElementNS("http://www.w3.org/2000/svg","text")
            label.setAttribute("x", bbox.x + bbox.width/2)
            label.setAttribute("y", bbox.y + bbox.height/2)
            label.setAttribute("class","pref-label")
            label.setAttribute("visibility","hidden")
            label.textContent = name

            svg.appendChild(label)
        }

        if(isTouchDevice){

            pref.addEventListener("touchend", function(e){

                if(isPinching && isZoomIn && label){
                    label.setAttribute("visibility","visible")
                    return
                }

                if(!isPinching){
                    this.classList.toggle("selected")
                }

            }, {passive:false})

        } else {
            pref.addEventListener("click", function(){
                this.classList.toggle("selected")
            })
        }

    })

    document.getElementById("resetBtn").addEventListener("click",()=>{
        prefs.forEach(p=>p.classList.remove("selected"))
        svg.querySelectorAll(".pref-label").forEach(l=>{
            l.setAttribute("visibility","hidden")
        })
    })

})
</script>

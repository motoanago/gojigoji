<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本地図</title>

<style>
body{
    margin:0;
    background:#f5f5f5;
    font-family:sans-serif;
    overflow:hidden;
}

#map-wrapper{
    width:100%;
    height:80vh;
    overflow:hidden;
    touch-action:none;
}

#map-wrapper svg{
    width:100%;
    height:100%;
}

.prefecture{
    fill:#ffffff;
    stroke:#333;
    stroke-width:0.5;
}

.selected{
    fill:#e60012 !important;
}

.pref-label{
    font-size:14px;
    font-weight:bold;
    fill:#000;
    text-anchor:middle;
    pointer-events:none;
}

button{
    display:block;
    margin:15px auto;
    padding:10px 20px;
}
</style>
</head>

<body>

<div id="map-wrapper"></div>
<button id="resetBtn">リセット</button>

<script>
let scale = 1
let startDistance = 0
let isPinching = false

function getDistance(touches){
    const dx = touches[0].clientX - touches[1].clientX
    const dy = touches[0].clientY - touches[1].clientY
    return Math.sqrt(dx*dx + dy*dy)
}

fetch("./map-mobile.svg")
.then(res => res.text())
.then(svgData => {

    document.getElementById("map-wrapper").innerHTML = svgData
    const svg = document.querySelector("svg")

    if (!svg.getAttribute("viewBox")) {
        const bbox = svg.getBBox()
        svg.setAttribute("viewBox", `0 0 ${bbox.width} ${bbox.height}`)
    }

    const prefs = svg.querySelectorAll('.prefecture')

    // ===== ラベル生成（内部座標使用）=====
    prefs.forEach(pref=>{

        const title = pref.querySelector("title")
        if(!title) return

        const name = title.textContent.split("/")[0].trim()
        const bbox = pref.getBBox()

        const label = document.createElementNS("http://www.w3.org/2000/svg","text")
        label.setAttribute("x", bbox.x + bbox.width/2)
        label.setAttribute("y", bbox.y + bbox.height/2)
        label.setAttribute("class","pref-label")
        label.setAttribute("visibility","hidden")
        label.textContent = name

        svg.appendChild(label)

        pref.addEventListener("touchend", function(){
            if(isPinching) return
            this.classList.toggle("selected")
        })

    })

    // ===== ピンチ開始 =====
    svg.addEventListener("touchstart", function(e){
        if(e.touches.length === 2){
            isPinching = true
            startDistance = getDistance(e.touches)
        }
    })

    // ===== ピンチ中 =====
    svg.addEventListener("touchmove", function(e){

        if(e.touches.length === 2){

            const currentDistance = getDistance(e.touches)
            const zoom = currentDistance / startDistance

            scale = Math.min(Math.max(1, zoom), 4)

            svg.style.transform = `scale(${scale})`
            svg.style.transformOrigin = "center center"

            // ★ 1より大きくなったら表示
            if(scale > 1.05){
                svg.querySelectorAll(".pref-label")
                   .forEach(l => l.setAttribute("visibility","visible"))
            }else{
                svg.querySelectorAll(".pref-label")
                   .forEach(l => l.setAttribute("visibility","hidden"))
            }

        }

    }, {passive:false})

    // ===== ピンチ終了 =====
    svg.addEventListener("touchend", function(e){
        if(e.touches.length < 2){
            isPinching = false

            // 100%に近ければ戻す
            if(scale <= 1.05){
                scale = 1
                svg.style.transform = "scale(1)"
                svg.querySelectorAll(".pref-label")
                   .forEach(l => l.setAttribute("visibility","hidden"))
            }
        }
    })

    // ===== リセット =====
    document.getElementById("resetBtn").addEventListener("click",()=>{
        scale = 1
        svg.style.transform = "scale(1)"
        prefs.forEach(p=>p.classList.remove("selected"))
        svg.querySelectorAll(".pref-label")
           .forEach(l=>l.setAttribute("visibility","hidden"))
    })

})
</script>

</body>
</html>

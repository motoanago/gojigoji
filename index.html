<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日本地図</title>

<style>
body{
    margin:0;
    background:#f5f5f5;
    font-family:sans-serif;
}

#map-wrapper{
    width:100vw;
    height:75vh;
    overflow:hidden;
}

#map-wrapper svg{
    width:100%;
    height:100%;
    display:block;
}

.pref-label{
    font-size:12px;
    font-weight:bold;
    fill:#000;
    text-anchor:middle;
    pointer-events:none;
}

.selected{
    fill:#e60012 !important;
}
</style>
</head>

<body>

<div id="map-wrapper"></div>

<script>

let isPinching = false

fetch("./map-mobile.svg")
.then(res=>res.text())
.then(svgData=>{

    document.getElementById("map-wrapper").innerHTML = svgData
    const svg = document.querySelector("svg")
    const prefs = svg.querySelectorAll(".prefecture")

    requestAnimationFrame(()=>{

        prefs.forEach(pref=>{

            const title = pref.querySelector("title")
            if(!title) return

            const name = title.textContent.split("/")[0].trim()

            const bbox = pref.getBBox()
            const matrix = pref.getScreenCTM()

            const point = svg.createSVGPoint()
            point.x = bbox.x + bbox.width/2
            point.y = bbox.y + bbox.height/2

            const globalPoint = point.matrixTransform(matrix)

            const label = document.createElementNS("http://www.w3.org/2000/svg","text")
            label.setAttribute("x", globalPoint.x)
            label.setAttribute("y", globalPoint.y)
            label.setAttribute("class","pref-label")
            label.setAttribute("visibility","hidden")
            label.textContent = name

            svg.appendChild(label)

        })

    })

    // ピンチ開始 → 表示
    svg.addEventListener("touchstart", e=>{
        if(e.touches.length === 2){
            isPinching = true
            svg.querySelectorAll(".pref-label")
               .forEach(l=>l.setAttribute("visibility","visible"))
        }
    }, {passive:true})

    // ピンチ終了 → 100%なら非表示
    svg.addEventListener("touchend", e=>{
        if(e.touches.length < 2){
            isPinching = false
            if(window.visualViewport.scale <= 1.05){
                svg.querySelectorAll(".pref-label")
                   .forEach(l=>l.setAttribute("visibility","hidden"))
            }
        }
    })

})
</script>

</body>
</html>

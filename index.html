<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>都道府県マップ</title>

<style>
body{
  margin:0;
  font-family:sans-serif;
  text-align:center;
  background:#f5f5f5;
}

h1{
  margin:10px 0;
  transform: scaleX(-1);
}

#map-container{
  width:100%;
  height:80vh;
  overflow:hidden;
  touch-action:none;
}

svg{
  width:100%;
  height:100%;
  transform: scaleX(-1);
}

.prefecture{
  fill:white;
  stroke:#333;
  stroke-width:1;
  cursor:pointer;
}

.prefecture.active{
  fill:red;
}

.pref-label{
  font-size:10px;
  pointer-events:none;
  fill:#000;
  user-select:none;
}

@media (max-width:768px){
  .pref-label{
    font-size:14px;
  }
}

button{
  margin:10px;
  padding:10px 20px;
  font-size:16px;
}
</style>
</head>

<body>

<h1>はいせんほにのかい</h1>
<div id="map-container"></div>
<button id="resetBtn">全て解除</button>

<script>
const container = document.getElementById("map-container");

// ===== 自動SVG切替 =====
function getSVGFile(){
  if(window.innerWidth <= 768){
    return "map-mobile.svg";
  } else {
    return "map-full.svg";
  }
}

let scale = 1;
let isPinching = false;

function loadMap(){

  fetch(getSVGFile())
  .then(res=>res.text())
  .then(data=>{

    container.innerHTML = data;

    const svg = container.querySelector("svg");

    const g = document.createElementNS("http://www.w3.org/2000/svg","g");

    while(svg.firstChild){
      g.appendChild(svg.firstChild);
    }
    svg.appendChild(g);

    const prefs = g.querySelectorAll(".prefecture");

    prefs.forEach(pref=>{

      const titleTag = pref.querySelector("title");
      if(!titleTag) return;

      const name = titleTag.textContent.split("/")[0].trim();

      pref.addEventListener("click",()=>{
        if(isPinching) return;
        pref.classList.toggle("active");
      });

      const bbox = pref.getBBox();

      const label = document.createElementNS("http://www.w3.org/2000/svg","text");
      label.setAttribute("x", bbox.x + bbox.width/2);
      label.setAttribute("y", bbox.y + bbox.height/2);
      label.setAttribute("text-anchor","middle");
      label.setAttribute("dominant-baseline","middle");
      label.setAttribute("class","pref-label");

      label.textContent = name;
      g.appendChild(label);
    });

    // ===== ピンチズーム =====
    let lastDistance = 0;

    container.addEventListener("touchstart", e=>{
      if(e.touches.length===2){
        isPinching = true;
        lastDistance = getDistance(e.touches);
      }
    });

    container.addEventListener("touchmove", e=>{
      if(e.touches.length===2){
        const distance = getDistance(e.touches);
        const diff = distance - lastDistance;

        scale += diff * 0.005;
        scale = Math.max(1, Math.min(scale,5));

        g.setAttribute("transform",`scale(${scale})`);

        lastDistance = distance;
      }
    });

    container.addEventListener("touchend", e=>{
      if(e.touches.length<2){
        setTimeout(()=>{isPinching=false},100);
      }
    });

    function getDistance(touches){
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx*dx+dy*dy);
    }

  });
}

loadMap();

// ===== 画面サイズ変更時も再読み込み =====
window.addEventListener("resize",()=>{
  container.innerHTML="";
  scale = 1;
  loadMap();
});

// ===== 全解除 =====
document.getElementById("resetBtn").addEventListener("click",()=>{
  document.querySelectorAll(".prefecture").forEach(p=>{
    p.classList.remove("active");
  });
});
</script>

</body>
</html>
